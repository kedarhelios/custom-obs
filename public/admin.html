<!DOCTYPE html>
<html>
    <head>
        <title>Admin Viewer - Multi Stream</title>
        <style>
            body {
                font-family: Arial, sans-serif;
            }
            h2 {
                text-align: center;
            }
            #videoContainer {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            video {
                width: 400px;
                height: 300px;
                background: #000;
            }
        </style>
    </head>
    <body>
        <h2>Live Feeds</h2>
        <div id="videoContainer"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();
            const videoContainer = document.getElementById("videoContainer");
            const peerConnections = {};

            function createVideoElement(streamerId) {
                const video = document.createElement("video");
                video.id = `video-${streamerId}`;
                video.autoplay = true;
                video.playsInline = true;
                video.controls = true;
                videoContainer.appendChild(video);
                return video;
            }

            socket.on("offer", async ({ offer, streamerId }) => {
                if (!streamerId) {
                    console.error("Missing streamerId in offer");
                    return;
                }

                const pc = new RTCPeerConnection();
                peerConnections[streamerId] = pc;

                pc.ontrack = (event) => {
                    let video = document.getElementById(`video-${streamerId}`);
                    if (!video) {
                        video = createVideoElement(streamerId);
                    }
                    video.srcObject = event.streams[0];
                };

                pc.onicecandidate = ({ candidate }) => {
                    if (candidate) {
                        socket.emit("ice-candidate", { candidate, streamerId });
                    }
                };

                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit("answer", { answer, streamerId });
            });

            socket.on("ice-candidate", async ({ candidate, streamerId }) => {
                const pc = peerConnections[streamerId];
                if (pc && candidate) {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                }
            });
        </script>
    </body>
</html>
